---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fuse.prep

<!-- badges: start -->
<!-- badges: end -->

O pacote **`{fuse.prep}`** tem o objetivo de gerar os dados de entrada para aplicação do
*Framework for Understanding Structural Errors* 
([FUSE](https://naddor.github.io/fuse/)) na escala de bacia hidrográfica 
(*catchment scale*). São necessários dois arquivos NetCDF 
de entrada para o FUSE:

- bandas de elevação do terreno: armazena as frações de área da bacia hidrográfica e da precipitação anual por banda de elevação;

- forçantes meteorológicas: armazena dados diários de temperatura do ar, 
precipitação, evapotranspiração potencial e opcionalmente de vazão observada;


## Instalação

O **{`fuse.prep`}** pode ser instalado do [GitHub](https://github.com/) com:

``` r
# install.packages("devtools")
devtools::install_github("lhmet-ped/fuse.prep")
```

### Arquivo NetCDF de bandas de elevação 

Os dados de exemplo são da Bacia Hidrográfica associada ao posto 74 (UHE G.B. MUNHOZ). 
Os dados necessários para geração do arquivo NetCDF de bandas de elevação: 

- raster da precipitação climatológica anual 

- raster da elevação do terreno hidrologicamente condicionado

- polígono da bacia hidrográfica (*Simple Feature*, `sf`)

Estes dados são disponibilizados com este pacote (`precclim74`) e com o pacote
**`{HEgis}`** (`poly74` e `condem74`).


```{r data}
library(HEgis)
poly74
condem74
library(fuse.prep)
precclim74
```

Para saber como estes 3 arquivos foram gerados veja a vinheta do pacote (`vignette(asd)`).

O arquivo NetCDF de bandas de elevação é gerado com a função `elev_bands_nc()`
que requer a tabela de bandas de elevação e o centróide do polígono.

A tabela de bandas de elevação é obtida com a função `elev_bands()`:

```{r elev_tab}
elev_bands_tab <- elev_bands(
  con_dem = condem74, 
  meteo_raster = precclim74, 
  nbands = 14
)
elev_bands_tab
```

O centróide do polígono da bacia hidrográfica é obtido com a função `centroids()`.


```{r centroides}
(poly_ctrd <- centroids(poly_station = poly74)  )
```

Com aquelas informações podemos então passá-las à `elev_bands_nc()` que as 
salva no arquivo NetCDF.

```{r elv_nc}
elev_bands_file <- elev_bands_nc(
  elev_tab = elev_bands_tab,
  ccoords = poly_ctrd,
  file_nc = file.path(tempdir(), "elevation_bands_74.nc"),
  na = -9999
)
elev_bands_file
file.exists(elev_bands_file)
```




```{r, include = FALSE}
#Verificação do arquivo gerado.
if (requireNamespace("tidync", quietly = TRUE)) {
  library(tidync)
  out <- tidync(elev_bands_file) %>% 
    hyper_tibble()
  # compara arquivo de exemplo do FUSE
  ref <- tidync("~/Dropbox/github/my_reps/lhmet/HEgis/refs/fuse_catch/input/us_09066300_elev_bands.nc") %>% hyper_tibble()
}
out
```
```{r, include = FALSE}
ref <- tidync::tidync("~/Dropbox/github/my_reps/lhmet/HEgis/refs/fuse_catch/input/us_09066300_input.nc") %>% tidync::hyper_tibble()
ref
names(ref)

```


## Arquivo NetCDF de forçantes meteorológicas

Para gerar o arquivo NetCDF com as séries temporais das forçantes hidrometeorológicas 
utilizaremos o conjunto de dados `forcdata74` disponibilizado neste pacote. 

```{r}
forcdata74
```

Cada variável é passada como um vetor nomeado conforme a seguir. Os nomes dos vetores devem seguir este padrão: `pr` para precipitação, `pet` para evapotranspiração potencial e `q_obs` para vazão observada. Além das séries temporais das variáveis precisamos das datas e o arquivo NetCDF que será salvo.

```{r}
pr <- forcdata74[["pr"]]
pet <- forcdata74[["pr"]]
q_obs <- forcdata74[["q_obs"]]
# arquivo de saída
forcings_nc <- "inst/extdata/posto74_input.nc"
# exporta dados para netcdf
meteo_forcing_nc(
  pr, pet, q_obs,
  dates = forcdata74[["date"]],
  ccoords = centroids(poly_station = poly74),
  file_nc = forcings_nc 
)
file.exists(forcings_nc)
```

```{r verif-forcings, include = FALSE}
library(tidync)
forcing_file <- "inst/extdata/posto74_input.nc"
out <- tidync(forcing_file) %>% hyper_tibble()
# compara arquivo de exemplo do FUSE
ref <- tidync("~/Dropbox/github/my_reps/lhmet/HEgis/refs/fuse_catch/input/us_09066300_input.nc") %>% 
  hyper_tibble()
out
ref
```


