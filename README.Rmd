---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fuse.prep

<!-- badges: start -->
<!-- badges: end -->

The goal of **`{fuse.prep}`** is to prepare the input data for the Framework for Understanding Structural Errors ([FUSE](https://naddor.github.io/fuse/)).



## Installation

You can install the development version of **{`fuse.prep`}** from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("lhmet-ped/fuse.prep")
```


## Data for generating the NetCDF files

Os dados de exemplo são da Bacia Hidrográfica associada ao posto 74 (UHE G.B. MUNHOZ). Os dados necessários para geração dos arquivos NetCDF são: 

- polígono da bacia hidrográfica (*Simple Feature*, `sf`)

- raster da elevação do terreno hidrologicamente condicionado

- raster da precipitação climatológica anual 

Estes dados são disponibilizados com os pacotes **`{HEgis}`** (`poly74` e `condem74`) e **`{fuse.prep}`** (`precclim74`).


```{r data}
library(HEgis)
poly74
condem74
library(fuse.prep)
precclim74
```

Para saber como gerar estes 3 arquivos veja a vinheta do pacote.

### Arquivo NetCDF de bandas de elevação 

O arquivo NetCDF de bandas de elevação é gerado com a função `elev_bands_nc()`
que utiliza a tabela de bandas de elevação e o centróide do polígono.

A tabela de bandas de elevação contém as frações de área da bacia hidrográfica e da precipitação anual por banda de elevação é obtida com a função `elev_bands()`:

```{r elev_tab}
elev_bands_tab <- elev_bands(
  con_dem = condem74, 
  meteo_raster = precclim74, 
  nbands = 14
)
elev_bands_tab
```

O centróide do polígono da bacia hidrográfica é obtido com a função `centroids()`.


```{r centroides}
(poly_ctrd <- centroids(poly_station = poly74)  )
```

Com aquelas informações podemos então salvá-las no arquivo NetCDF.

```{r elv_nc}
elev_bands_file <- elev_bands_nc(
  elev_tab = elev_bands_tab,
  ccoords = poly_ctrd,
  file_nc = file.path(tempdir(), "elevation_bands_74.nc"),
  na = -9999
)
elev_bands_file
file.exists(elev_bands_file)
```




```{r, include = FALSE}
#Verificação do arquivo gerado.
if (requireNamespace("tidync", quietly = TRUE)) {
  library(tidync)
  out <- tidync(elev_bands_file) %>% hyper_tibble()
  # compara arquivo de exemplo do FUSE
  ref <- tidync("~/Dropbox/github/my_reps/lhmet/HEgis/refs/fuse_catch/input/us_09066300_elev_bands.nc") %>% hyper_tibble()
}
out
```
```{r, include = FALSE}
ref
```





## Arquivo NetCDF de forçantes meteorológicas


https://github.com/naddor/tofu/blob/master/input_output_settings/write_forcing.R

